<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Chat Privado</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <link rel="stylesheet" href="style.css">
  <style>
    body { font-family: sans-serif; max-width: 700px; margin: 0 auto; padding: 8px; }
    .chat-box { border: 1px solid #ddd; border-radius: 10px; height: 65vh; overflow-y: auto; padding: 8px; background: #fafafa; }
    .msg { padding: 6px 8px; margin: 6px 0; border-radius: 8px; border: 1px solid #eee; background: #fff; }
    .meta { font-size: 12px; opacity: 0.7; margin-bottom: 4px; }
    .me { border-color: #cde; background: #eef7ff; }
    .row { display: flex; gap: 6px; margin-top: 8px; }
    .row input[type="text"] { flex: 1; padding: 10px; font-size: 16px; }
    .row button { padding: 10px; font-size: 16px; }
    .topbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
    .small { font-size: 12px; opacity: 0.7; }
    .admin-btns { display: none; margin-left: 10px; }

    /* notice */
    #notice { margin: 6px 0; font-size: 13px; color: #444; min-height: 18px; }

    /* modal sin alert/confirm */
    .modal {
      display: none;
      position: fixed; top:0; left:0; right:0; bottom:0;
      background: rgba(0,0,0,0.6);
      justify-content: center; align-items: center;
    }
    .modal-content {
      background: #fff; padding: 16px; border-radius: 8px;
      text-align: center; max-width: 300px;
    }
    .modal-content button { margin: 8px; padding: 8px 14px; }
  </style>
</head>
<body>
  <div class="topbar">
    <div>ðŸ’¬ Chat Privado - <span id="roomLabel"></span></div>
    <div class="small">
      <span id="nickLabel"></span> | <a href="index.html">Salir</a>
      <span id="adminBtns" class="admin-btns">
        <button id="deleteBtn">ðŸ—‘ Borrar chat</button>
      </span>
    </div>
  </div>

  <!-- Avisos (reemplaza alert()) -->
  <div id="notice" aria-live="polite"></div>

  <div id="messages" class="chat-box" aria-live="polite"></div>

  <div class="row">
    <input id="msgInput" type="text" maxlength="500" placeholder="Escribe un mensajeâ€¦">
    <button id="sendBtn">Enviar</button>
  </div>

  <!-- Modal de confirmaciÃ³n -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <p>Â¿Seguro que quieres borrar todo el chat?</p>
      <button id="yesBtn">SÃ­</button>
      <button id="noBtn">No</button>
    </div>
  </div>

  <!-- Firebase v8 (compatible con Kindle) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <!-- LÃ³gica del chat -->
  <script src="chat.js"></script>

  <script>
    // Mostrar botÃ³n admin solo si corresponde (lo pusimos en index.html)
    var isAdmin = sessionStorage.getItem("is_admin") === "1";
    if (isAdmin) {
      document.getElementById("adminBtns").style.display = "inline";
    }

    // Modal y botones (sin usar alert/confirm)
    const modal = document.getElementById("modal");
    const deleteBtn = document.getElementById("deleteBtn");
    const noBtn = document.getElementById("noBtn");
    const yesBtn = document.getElementById("yesBtn");

    if (deleteBtn) {
      deleteBtn.onclick = () => { modal.style.display = "flex"; };
    }
    if (noBtn) {
      noBtn.onclick = () => { modal.style.display = "none"; };
    }
    if (yesBtn) {
      yesBtn.onclick = () => {
        modal.style.display = "none";
        // Llamamos a la funciÃ³n global deleteChat definida en chat.js
        if (typeof window.deleteChat === "function") {
          window.deleteChat();
        } else if (window.database && typeof getRoomId === "function") {
          // fallback si por alguna razÃ³n chat.js no cargÃ³ correctamente
          window.database.ref("rooms/" + getRoomId() + "/messages").remove()
            .then(() => {
              document.getElementById("messages").innerHTML = "";
              document.getElementById("notice").textContent = "Chat borrado âœ…";
            })
            .catch(err => {
              document.getElementById("notice").textContent = "Error al borrar: " + err;
            });
        } else {
          document.getElementById("notice").textContent = "No se pudo borrar (no conectado)";
        }
      };
    }
  </script>
</body>
</html>